# VIZ-001: Core Visualization System

## Objective
Implement core hex grid visualization with JPEG/PNG export, elevation color mapping, hillshading, debug overlays, and validation output. Provide foundation for all future visualization needs.

## Technical Approach

### Rendering Engine Design
- **Pixel-based rendering**: Convert hex grid to pixel coordinates for image generation
- **Layer-based system**: Separate rendering layers (elevation, water, debug overlays)
- **Color mapping**: Scientific color schemes for elevation data
- **Hillshading**: 3D appearance using slope/aspect calculations
- **Metadata embedding**: Store generation parameters in image metadata

### Core Visualization Features
- **Elevation mapping**: Terrain-style color schemes with realistic gradients
- **Water rendering**: Ocean blue with depth-based shading
- **Hillshading**: Simulated lighting for 3D terrain appearance
- **Debug overlays**: Hex coordinates, neighbor connections, validation markers
- **Composite views**: Multiple layer combinations for comprehensive visualization

### Image Export System
- **JPEG/PNG support**: High-quality export with configurable compression
- **Embedded metadata**: Store world generation parameters and statistics
- **Scalable output**: Configurable resolution and hex size
- **Batch rendering**: Support for multiple visualization types

## API Design

### Core Rendering Types
```go
package render

import (
    "image"
    "image/color"
    "github.com/sean/hex-map/pkg/hex"
    "github.com/sean/hex-map/pkg/terrain"
)

// RenderConfig controls visualization output
type RenderConfig struct {
    Width       int               // Image width in pixels
    Height      int               // Image height in pixels
    HexSize     float64          // Hex radius in pixels
    Layers      []RenderLayer    // Active rendering layers
    ColorScheme ColorScheme      // Color mapping scheme
    ShowDebug   bool            // Enable debug overlays
    Quality     int             // JPEG quality (1-100)
}

// RenderLayer defines what to visualize
type RenderLayer int
const (
    LayerElevation RenderLayer = iota
    LayerWater
    LayerHillshade
    LayerDebugCoords
    LayerDebugNeighbors
    LayerValidation
)

// ColorScheme defines color mapping approaches
type ColorScheme int
const (
    SchemeElevation ColorScheme = iota  // Terrain-style elevation colors
    SchemeRealistic                     // Earth-like realistic colors
    SchemeDebug                         // High-contrast debug colors
    SchemeGrayscale                     // Grayscale for scientific analysis
)

// HexRenderer is the main rendering engine
type HexRenderer struct {
    config  RenderConfig
    grid    *hex.Grid
    canvas  *image.RGBA
    bounds  image.Rectangle
}

// RenderMetadata contains information embedded in exported images
type RenderMetadata struct {
    Generator     string                `json:"generator"`
    Timestamp     string                `json:"timestamp"`
    WorldSeed     int64                 `json:"world_seed"`
    Stage         string                `json:"generation_stage"`
    ViewConfig    RenderConfig          `json:"view_config"`
    TerrainStats  terrain.TerrainStats  `json:"terrain_stats"`
    QualityScore  float64              `json:"quality_score"`
    KnownIssues   []string             `json:"known_issues"`
}
```

### Core Rendering Functions
```go
// Create new renderer for hex grid
func NewHexRenderer(grid *hex.Grid, config RenderConfig) *HexRenderer

// Render terrain data to image
func (r *HexRenderer) RenderTerrain(tiles []*terrain.HexTile) (*image.RGBA, error)

// Render single layer
func (r *HexRenderer) RenderLayer(layer RenderLayer, tiles []*terrain.HexTile) error

// Apply color mapping to elevation data
func (r *HexRenderer) MapElevationToColor(elevation float64, scheme ColorScheme) color.RGBA

// Generate hillshading effect
func (r *HexRenderer) RenderHillshade(tiles []*terrain.HexTile, lightAngle float64) error

// Add debug overlays
func (r *HexRenderer) RenderDebugOverlay(showCoords, showNeighbors bool) error

// Export to image files
func (r *HexRenderer) ExportJPEG(filename string, quality int) error
func (r *HexRenderer) ExportPNG(filename string) error
```

### Color Mapping System
```go
// ElevationColorMap maps elevation ranges to colors
type ElevationColorMap struct {
    SeaLevel    float64
    Breakpoints []ColorBreakpoint
}

type ColorBreakpoint struct {
    Elevation float64
    Color     color.RGBA
}

// Predefined color schemes
func TerrainColorScheme() ElevationColorMap
func RealisticEarthScheme() ElevationColorMap
func DebugColorScheme() ElevationColorMap

// Custom color interpolation
func InterpolateColor(c1, c2 color.RGBA, ratio float64) color.RGBA
func ElevationToColor(elevation float64, colorMap ElevationColorMap) color.RGBA
```

### Validation and Stats Output
```go
// ValidationRenderer creates debug visualizations
type ValidationRenderer struct {
    renderer *HexRenderer
}

// Generate validation report with visualization
func (vr *ValidationRenderer) GenerateReport(tiles []*terrain.HexTile) (*ValidationReport, error)

type ValidationReport struct {
    Stats       terrain.TerrainStats  `json:"stats"`
    Anomalies   []ElevationAnomaly   `json:"anomalies"`
    ImagePath   string               `json:"image_path"`
    Metadata    RenderMetadata       `json:"metadata"`
}

type ElevationAnomaly struct {
    Location    hex.AxialCoord `json:"location"`
    Type        string         `json:"type"`
    Severity    string         `json:"severity"`
    Value       float64        `json:"value"`
    Description string         `json:"description"`
}
```

## File Structure
```
pkg/
  render/
    renderer.go          // Core HexRenderer implementation
    renderer_test.go     // Rendering engine tests
    colormap.go          // Color mapping and schemes
    colormap_test.go     // Color mapping tests
    export.go           // JPEG/PNG export with metadata
    export_test.go      // Export functionality tests
    hillshade.go        // Hillshading algorithms
    hillshade_test.go   // Hillshading tests
    debug.go            // Debug overlay rendering
    debug_test.go       // Debug rendering tests
  validation/
    report.go           // Validation report generation
    report_test.go      // Validation report tests
    visualize.go        // Validation visualization tools
    visualize_test.go   // Validation visualization tests
cmd/
  hex-world/
    render.go           // Render-related CLI commands
```

## Testing Strategy

### Unit Tests
- **Color Mapping**: Verify elevation-to-color conversion accuracy
- **Coordinate Conversion**: Test hex-to-pixel coordinate calculations
- **Layer Rendering**: Individual layer rendering correctness
- **Hillshading**: Validate lighting calculations and visual output
- **Metadata**: Ensure proper embedding and extraction

### Integration Tests
- **Full Pipeline**: Terrain generation → visualization → export
- **Multiple Formats**: JPEG and PNG export with various settings
- **Layer Combinations**: Test all layer combination permutations
- **Grid Topologies**: Both region and world topology visualization
- **Size Scaling**: Various grid sizes and output resolutions

### Visual Validation Tests
- **Reference Images**: Compare output against known-good reference images
- **Pixel Accuracy**: Verify exact pixel values for test cases
- **Color Consistency**: Ensure color mapping produces expected results
- **Metadata Integrity**: Validate embedded metadata round-trip

### Performance Tests
- **Large Grids**: 1000x1000 rendering performance benchmarks
- **Memory Usage**: Memory consumption during rendering
- **Export Speed**: JPEG/PNG export performance
- **Layer Efficiency**: Individual layer rendering performance

## Implementation Phases

### Phase 1: Core Renderer (Day 1)
1. HexRenderer struct and basic configuration
2. Hex-to-pixel coordinate conversion
3. Basic image canvas setup and management
4. Simple solid color hex rendering

### Phase 2: Color Mapping (Day 1)
1. ElevationColorMap implementation
2. Color interpolation algorithms
3. Predefined color schemes (terrain, realistic, debug)
4. Elevation-to-color mapping functions

### Phase 3: Layer System (Day 2)
1. Layer-based rendering architecture
2. Elevation layer with color mapping
3. Water layer with depth-based coloring
4. Debug overlay with coordinates

### Phase 4: Hillshading (Day 2)
1. Slope and aspect calculation from elevation data
2. Lighting model implementation
3. Hillshading effect generation
4. Integration with elevation rendering

### Phase 5: Export System (Day 3)
1. JPEG export with quality control
2. PNG export with transparency support
3. Metadata embedding in image files
4. Validation report generation

### Phase 6: CLI Integration (Day 3)
1. Render commands in hex-world CLI
2. Batch rendering capabilities
3. Configuration file support
4. Demo commands for visualization

## Scientific Accuracy

### Color Mapping Standards
- **Elevation Colors**: Follow standard topographic color conventions
- **Bathymetry**: Standard ocean depth color schemes
- **Terrain Visualization**: Earth-like realistic color gradients
- **Accessibility**: Support for colorblind-friendly palettes

### Hillshading Parameters
- **Light Angle**: Standard 315° azimuth, 45° altitude
- **Vertical Exaggeration**: Configurable based on terrain scale
- **Shadow Intensity**: Realistic shadowing without oversaturation
- **Edge Handling**: Proper boundary condition handling

## CLI Commands

### Basic Rendering
```bash
# Render elevation map
./hex-world render --input=terrain.json --mode=elevation --output=elevation.jpg

# Render with hillshading
./hex-world render --input=terrain.json --mode=hillshade --output=terrain.png

# Debug visualization
./hex-world render --input=terrain.json --mode=debug --show-coords=true --output=debug.png
```

### Advanced Rendering
```bash
# Multiple layers
./hex-world render --input=terrain.json \
  --layers=elevation,water,hillshade \
  --scheme=realistic \
  --resolution=2048x2048 \
  --output=composite.jpg

# Validation report
./hex-world validate-render --input=terrain.json --output-dir=validation/
```

### Batch Processing
```bash
# Render all visualization types
./hex-world render-all --input=terrain.json --output-dir=images/

# Compare different color schemes
./hex-world compare-schemes --input=terrain.json --schemes=terrain,realistic,debug
```

## Success Criteria

### Functional Requirements
1. ✅ Render hex grids as high-quality images (JPEG/PNG)
2. ✅ Color mapping for elevation data with multiple schemes
3. ✅ Hillshading for 3D terrain appearance
4. ✅ Debug overlays with coordinates and validation markers
5. ✅ Metadata embedding in exported images

### Quality Requirements
1. ✅ >90% test coverage for all rendering code
2. ✅ Performance: Render 100x100 grid in <2 seconds
3. ✅ Memory efficiency: Handle 1000x1000 grids
4. ✅ Visual accuracy: Pixel-perfect reference image matching
5. ✅ Export quality: Publication-ready image output

### Integration Requirements
1. ✅ Seamless integration with existing terrain system
2. ✅ Support for both region and world topology grids
3. ✅ CLI commands follow existing patterns
4. ✅ Extensible for future visualization features
5. ✅ Validation output compatible with debugging tools

## Dependencies
- **HEX-001**: Hex grid coordinate system ✅
- **TERRAIN-001**: Terrain generation and HexTile data ✅
- **Go Standard Library**: image, image/jpeg, image/png packages
- **Future Integration**: Prepares for TERRAIN-002 (enhanced terrain visualization)

## Performance Targets
- **Small Grids** (50x50): <200ms rendering time
- **Medium Grids** (200x200): <2s rendering time
- **Large Grids** (1000x1000): <30s rendering time
- **Memory Usage**: <100MB for 1000x1000 grid rendering
- **Export Speed**: <500ms for JPEG/PNG export

## Color Scheme Specifications

### Terrain Color Scheme (Standard Topographic)
```
Water: Deep Blue (#000080) to Light Blue (#4169E1)
Beach: Tan (#F4A460)
Plains: Light Green (#90EE90)
Hills: Yellow-Green (#9ACD32)
Mountains: Brown (#8B4513) to White (#FFFFFF)
```

### Realistic Earth Scheme
```
Ocean: Navy (#000080) to Blue (#0066CC)
Coastal: Sand (#F4C2A1) to Light Green (#C8E6C8)
Lowlands: Green (#228B22) to Dark Green (#006400)
Highlands: Brown (#A0522D) to Gray (#696969)
Peaks: White (#FFFFFF)
```

### Debug Scheme (High Contrast)
```
Water: Bright Blue (#0000FF)
Land: Bright Green (#00FF00)
Anomalies: Bright Red (#FF0000)
Edges: Yellow (#FFFF00)
```